{{- $index := slice -}}
{{- $pages := .Site.RegularPages -}}
{{- if .Site.Params.page.hiddenFromSearch -}}
    {{- $pages = where $pages "Params.hiddenfromsearch" false -}}
{{- else -}}
    {{- $pages = where $pages "Params.hiddenfromsearch" "!=" true -}}
{{- end -}}
{{- range $pages -}}
    {{- $uri := .RelPermalink -}}
    {{- $meta := dict "uri" $uri "title" .Title "tags" .Params.tags "categories" .Params.categories -}}
    {{- $meta = .PublishDate.Format ($.Site.Params.dateFormat | default "2006-01-02") | dict "date" | merge $meta -}}
    {{- with .Description -}}
        {{- $index = $index | append (dict "content" . "objectID" $uri | merge $meta) -}}
    {{- end -}}
    {{- $params := .Params | merge $.Site.Params.page -}}
    {{- $content := dict "content" .Content "ruby" $params.ruby "fraction" $params.fraction "fontawesome" $params.fontawesome | partial "function/content.html" -}}
    {{- range $i, $chunked := split $content "<h2 id=" -}}
        {{- if gt $i 0 -}}
            {{- $chunked = printf "<h2 id=%s" $chunked -}}
        {{- end -}}
        {{- $chunked = $chunked | plainify | htmlUnescape | replace "\n" " " | replace "\t" " " | replaceRE " +" " " -}}
        {{- if gt $.Site.Params.search.contentLength 0 -}}
            {{- $chunked = substr $chunked 0 $.Site.Params.search.contentLength -}}
        {{- end -}}
        {{- $one := printf "%s:%d" $uri $i | dict "content" $chunked "objectID" | merge $meta -}}
        {{- $index = $index | append $one -}}
    {{- end -}}
{{- end -}}

{{- $index | jsonify | safeJS -}}
